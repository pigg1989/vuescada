!function(N,l,o){"use strict";var M="ht",Q=N[M],y=Q.Default,n=y.def,B=y.getInternal();Q.HistoryManager=function(b){this._histories=[],this.setDataModel(b)},n(Q.HistoryManager,l,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var O=this;O._betweenTransaction++,1===O._betweenTransaction&&(O._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var A=this,e=A._histories;if(A._betweenTransaction>0&&A._betweenTransaction--,0===A._betweenTransaction){if(A._transactionHistories){var C=[];for(var D in A._transactionHistories)C.push(A._transactionHistories[D]);C.length&&(e=e.slice(0,A._historyIndex+1),e.push(C),e.length>A._maxHistoryCount&&(e=e.slice(e.length-A._maxHistoryCount)),A.setHistories(e),A.setHistoryIndex(e.length-1,!0))}delete A._transactionHistories}}},setDataModel:function(X){var t=this,C=t._dataModel;C!==X&&(C&&(delete C._historyManager,C.ump(t.handleDataModelPropertyChange,t),C.umm(t.$5p,t),C.umd(t.$6p,t),C.removeHierarchyChangeListener(t.handleHierarchyChange,t),C.removeIndexChangeListener(t.handleIndexChange,t)),t._dataModel=X,X&&(X._historyManager=t,X.mp(t.handleDataModelPropertyChange,t),X.mm(t.$5p,t),X.md(t.$6p,t),X.addHierarchyChangeListener(t.handleHierarchyChange,t),X.addIndexChangeListener(t.handleIndexChange,t)),t.fp("dataModel",C,X),t.clear())},setHistoryIndex:function(P,L){var j=this,m=j._historyIndex,s=j._histories.length;if(-1>P?P=-1:P>=s&&(P=s-1),m!==P){if(!L){var f=P-m;f>0?j.$2p(f):0>f&&j.$1p(-f)}j._historyIndex=P,j.fp("historyIndex",m,P),j.dataModel&&j.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(e){var M=this,Q=M._histories,R=M._maxHistoryCount;(!e||0>=e)&&(e=10),R!==e&&(M._maxHistoryCount=e,M.fp("maxHistoryCount",R,e),Q.length>e&&M.clear())},cloneValue:function(y){return Q.Default.clone(y)},isPropertyUndoable:function(R){return R&&!this.ignoredPropertyMap[R]},isDataModelPropertyUndoable:function(c){return c&&!this.ignoreDataModelPropertyMap[c]},$5p:function(d){this.handleChange(d,d.kind)},$6p:function(t){this.handleChange(t,"property")},handleHierarchyChange:function(l){this.handleChange(l,"hierarchy")},handleIndexChange:function($){this.handleChange($,"index")},handleDataModelPropertyChange:function(i){this.handleChange(i,"dataModelProperty")},toChildrenInfo:function(m){var b={};return b.data=m,b.children=[],m.eachChild(function(w){b.children.push(this.toChildrenInfo(w))},this),b},restoreChildren:function(t){var L=t.data;t.children.forEach(function(N){var i=N.data;i.getParent()!==L&&L.addChild(i),this._dataModel.contains(i)||this._dataModel.add(i),this.restoreChildren(N)},this)},handleChange:function($,q){var e=this;if(!(e._disabled||e._isUndoRedoing||y.loadingRefGraph)){var i,S=(e._histories,$.data),L=$.property;if(!S||!(S._refGraph||S instanceof Q.RefGraph)){if("property"===q)e.isPropertyUndoable(L,S)&&(i={kind:q,data:S,property:L,oldValue:e.cloneValue($.oldValue,S,L),newValue:e.cloneValue($.newValue,S,L),event:$});else if("hierarchy"===q||"index"===q)i={kind:q,data:S,oldIndex:$.oldIndex,newIndex:$.newIndex,event:$};else if("clear"===q)i={kind:q,json:$.json,event:$};else if("add"===q){if(i={kind:q,data:S,event:$,childrenInfo:this.toChildrenInfo(S),parent:S.getParent()},i.parent){var U=e._dataModel.getSiblings(S);i.siblingsIndex=U.indexOf(S)}S instanceof Q.Node&&(i.host=S.getHost(),i.attaches=S.getAttaches()?S.getAttaches().toArray():o),S instanceof Q.Edge&&(i.source=S.getSource(),i.target=S.getTarget())}else"remove"===q?i={kind:q,data:S,event:$}:"dataModelProperty"===q&&e.isDataModelPropertyUndoable(L,S)&&(i={kind:q,property:L,oldValue:e.cloneValue($.oldValue,S,L),newValue:e.cloneValue($.newValue,S,L),event:$});e.addHistory(i)}}},addHistory:function($){var o=this;if($)if(o._betweenTransaction){var v=($.data?$.data._id:0)+"_"+$.kind+"_"+$.property;if("property"===$.kind||"dataModelProperty"===$.kind){var e=o._transactionHistories[v];e&&($.oldValue=e.oldValue)}o._transactionHistories[v]=$}else{var _=o._histories;_=_.slice(0,o._historyIndex+1),_.push([$]),_.length>o._maxHistoryCount&&(_=_.slice(_.length-o._maxHistoryCount)),o.setHistories(_),o.setHistoryIndex(_.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(Z){(!Z||0>=Z)&&(Z=1),this.setHistoryIndex(this._historyIndex-Z)},$1p:function(r){if(this.canUndo()){var X,I=this,Q=I._dataModel,x=I._histories,H=I._historyIndex,W=0;for(I._isUndoRedoing=!0,y.setIsolating(!0);r>0;){if(H>=0&&H<x.length){W++,X=x[H],H--;for(var O=X.length-1;O>=0;O--){var R=X[O],S=R.kind,M=R.data,v=R.property,l=R.event,s=this.cloneValue(R.oldValue,M,v);if(R.undo)R.undo();else if("add"===S)Q.remove(M,{keepChildren:!0});else if("remove"===S)Q.contains(M)||Q.add(M,l.rootsIndex,l.datasIndex);else if("clear"===S)Q.deserialize(y.clone(R.json));else if("property"===S)if("parent"===v)s?s.addChild(M,l.oldIndex):(M.setParent(s),l.oldIndex>=0&&Q.moveTo(M,l.oldIndex));else{var b=null;0===v.indexOf("a:")?(b="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(b="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(b="field",v=v.replace("f:","")),B.setPropertyValue(M,b,v,s)}else if("dataModelProperty"===S){var b=null;0===v.indexOf("a:")?(b="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(b="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(b="field",v=v.replace("f:","")),B.setPropertyValue(Q,b,v,s)}else"hierarchy"===S?Q.moveTo(M,R.oldIndex):"index"===S&&Q.moveToIndex(M,R.oldIndex)}}r--}y.setIsolating(!1),delete I._isUndoRedoing,I.afterUndo(W)}},afterUndo:function(){},redo:function(B){(!B||0>=B)&&(B=1),this.setHistoryIndex(this._historyIndex+B)},$2p:function(i){if(this.canRedo()){var q,b=this,Z=b._dataModel,$=b._histories,Y=b._historyIndex,X=0;for(b._isUndoRedoing=!0,y.setIsolating(!0);i>0;){if(Y>=-1&&Y<$.length-1){X++,Y++,q=$[Y];for(var S=0;S<q.length;S++){var _=q[S],N=_.kind,A=_.data,k=_.property,I=_.event,a=this.cloneValue(_.newValue,A,k);if(_.redo)_.redo();else if("add"===N)_.parent&&!A.getParent()&&_.parent.addChild(A,_.siblingsIndex),Z.contains(A)||Z.add(A,I.rootsIndex,I.datasIndex),this.restoreChildren(_.childrenInfo),A instanceof Q.Node&&(A.setHost(_.host),_.attaches&&_.attaches.forEach(function(R){R.setHost(A)})),A instanceof Q.Edge&&(A.setSource(_.source),A.setTarget(_.target));else if("remove"===N)Z.remove(A);else if("clear"===N)Z.clear();else if("property"===N)if("parent"===k)a?a.addChild(A,I.newIndex):(A.setParent(a),I.newIndex>=0&&Z.moveTo(A,I.newIndex));else{var R=null;0===k.indexOf("a:")?(R="attr",k=k.replace("a:","")):0===k.indexOf("s:")?(R="style",k=k.replace("s:","")):0===k.indexOf("f:")&&(R="field",k=k.replace("f:","")),B.setPropertyValue(A,R,k,a)}else if("dataModelProperty"===N){var R=null;0===k.indexOf("a:")?(R="attr",k=k.replace("a:","")):0===k.indexOf("s:")?(R="style",k=k.replace("s:","")):0===k.indexOf("f:")&&(R="field",k=k.replace("f:","")),B.setPropertyValue(Z,R,k,a)}else"hierarchy"===N?Z.moveTo(A,_.newIndex):"index"===N&&Z.moveToIndex(A,_.newIndex)}}i--}y.setIsolating(!1),delete b._isUndoRedoing,this.afterRedo(X)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);